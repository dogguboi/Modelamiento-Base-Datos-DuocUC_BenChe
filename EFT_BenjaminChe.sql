-- fase 3

-- sin interrupciones
SET DEFINE OFF;

CREATE TABLE REGION (
  ID_REGION NUMBER PRIMARY KEY,
  NOMBRE_REGION VARCHAR2(100) NOT NULL,
  CONSTRAINT UN_REGION_NOMBRE UNIQUE (NOMBRE_REGION)
);

CREATE TABLE COMUNA (
  ID_COMUNA NUMBER GENERATED BY DEFAULT AS IDENTITY (START WITH 1050 INCREMENT BY 5),
  NOMBRE_COMUNA VARCHAR2(100) NOT NULL,
  REGION_ID NUMBER NOT NULL,
  CONSTRAINT PK_COMUNA PRIMARY KEY (ID_COMUNA),
  CONSTRAINT FK_COMUNA_REGION FOREIGN KEY (REGION_ID)
    REFERENCES REGION(ID_REGION)
);

CREATE TABLE PLANTA (
  ID_PLANTA NUMBER PRIMARY KEY,
  NOMBRE_PLANTA VARCHAR2(120) NOT NULL,
  DIRECCION VARCHAR2(200),
  COMUNA_ID NUMBER NOT NULL,
  CONSTRAINT FK_PLANTA_COMUNA FOREIGN KEY (COMUNA_ID)
    REFERENCES COMUNA(ID_COMUNA)
);

CREATE TABLE TIPO_MAQUINA (
  ID_TIPO_MAQUINA NUMBER PRIMARY KEY,
  NOMBRE_TIPO VARCHAR2(100) NOT NULL,
  CONSTRAINT UN_TIPO_MAQUINA_NOMBRE UNIQUE (NOMBRE_TIPO)
);

CREATE TABLE TURNO (
  ID_TURNO VARCHAR2(10) PRIMARY KEY,
  NOMBRE_TURNO VARCHAR2(50) NOT NULL,
  HORA_INICIO CHAR(5) NOT NULL,  -- formato 'HH:MM'
  HORA_FIN CHAR(5) NOT NULL,
  CONSTRAINT UN_TURNO_NOMBRE UNIQUE (NOMBRE_TURNO)
);

CREATE TABLE MAQUINA (
  NRO_MAQUINA NUMBER NOT NULL,
  PLANTA_ID NUMBER NOT NULL,
  NOMBRE_MAQUINA VARCHAR2(150),
  ESTADO_ACTIVO CHAR(1) DEFAULT 'S' NOT NULL,
  ID_TIPO_MAQUINA NUMBER NOT NULL,
  CONSTRAINT MAQ_PK PRIMARY KEY (NRO_MAQUINA, PLANTA_ID),
  CONSTRAINT MAQ_FK_PLANTA FOREIGN KEY (PLANTA_ID) REFERENCES PLANTA(ID_PLANTA),
  CONSTRAINT MAQ_FK_TIPO FOREIGN KEY (ID_TIPO_MAQUINA) REFERENCES TIPO_MAQUINA(ID_TIPO_MAQUINA),
  CONSTRAINT MAQ_CK_ESTADO CHECK (ESTADO_ACTIVO IN ('S','N'))
);

CREATE TABLE EMPLEADO (
  ID_EMPLEADO NUMBER PRIMARY KEY,
  RUT VARCHAR2(15) UNIQUE NOT NULL,
  NOMBRES VARCHAR2(100) NOT NULL,
  APELLIDOS VARCHAR2(100) NOT NULL,
  FECHA_CONTRATACION DATE,
  SUELDO_BASE NUMBER(12,2),
  ESTADO_ACTIVO CHAR(1) DEFAULT 'S' NOT NULL,
  PLANTA_ID NUMBER NOT NULL,
  AFP VARCHAR2(100),
  SISTEMA_SALUD VARCHAR2(100),
  JEFE_DIRECTO_ID NUMBER NULL,
  CONSTRAINT EMP_FK_PLANTA FOREIGN KEY (PLANTA_ID) REFERENCES PLANTA(ID_PLANTA),
  CONSTRAINT EMP_FK_JEFE FOREIGN KEY (JEFE_DIRECTO_ID) REFERENCES EMPLEADO(ID_EMPLEADO),
  CONSTRAINT EMP_CK_ESTADO CHECK (ESTADO_ACTIVO IN ('S','N'))
);

-- -----------------------------
-- Subtablas (especialización) JEFE_TURNO, OPERARIO, TECNICO_MANT
-- -----------------------------
CREATE TABLE JEFE_TURNO (
  ID_EMPLEADO NUMBER PRIMARY KEY,
  AREA_RESPONSABILIDAD VARCHAR2(100),
  MAX_OPERARIOS NUMBER,
  CONSTRAINT JEFE_FK_EMP FOREIGN KEY (ID_EMPLEADO) REFERENCES EMPLEADO(ID_EMPLEADO)
);

CREATE TABLE OPERARIO (
  ID_EMPLEADO NUMBER PRIMARY KEY,
  CATEGORIA_PROCESO VARCHAR2(50),
  CERTIFICACION VARCHAR2(100),
  HORAS_POR_TURNO NUMBER DEFAULT 8,
  CONSTRAINT OPER_FK_EMP FOREIGN KEY (ID_EMPLEADO) REFERENCES EMPLEADO(ID_EMPLEADO)
);

CREATE TABLE TECNICO_MANT (
  ID_EMPLEADO NUMBER PRIMARY KEY,
  ESPECIALIDAD VARCHAR2(50),
  NIVEL_CERTIFICACION VARCHAR2(50),
  TIEMPO_RESPUESTA_ESTANDAR NUMBER, -- en minutos (convención)
  CONSTRAINT TEC_FK_EMP FOREIGN KEY (ID_EMPLEADO) REFERENCES EMPLEADO(ID_EMPLEADO)
);

CREATE TABLE ORDEN_MANTENCION (
  ID_ORDEN NUMBER PRIMARY KEY,
  NRO_MAQUINA NUMBER NOT NULL,
  PLANTA_ID NUMBER NOT NULL,
  ID_TECNICO NUMBER NOT NULL,
  FECHA_PROGRAMADA DATE NOT NULL,
  FECHA_EJECUCION DATE,
  DESCRIPCION CLOB,
  CONSTRAINT OM_FK_MAQUINA FOREIGN KEY (NRO_MAQUINA, PLANTA_ID)
    REFERENCES MAQUINA(NRO_MAQUINA, PLANTA_ID),
  CONSTRAINT OM_FK_TECNICO FOREIGN KEY (ID_TECNICO) REFERENCES EMPLEADO(ID_EMPLEADO),
  CONSTRAINT OM_CK_FECHAS CHECK (FECHA_EJECUCION IS NULL OR FECHA_EJECUCION >= FECHA_PROGRAMADA)
);

CREATE TABLE ASIGNACION_TURNO (
  ID_ASIGNACION NUMBER PRIMARY KEY,
  FECHA DATE NOT NULL,
  ID_EMPLEADO NUMBER NOT NULL,
  ID_TURNO VARCHAR2(10) NOT NULL,
  NRO_MAQUINA NUMBER NOT NULL,
  PLANTA_ID NUMBER NOT NULL,
  ROL_EN_TURNO VARCHAR2(80),
  CONSTRAINT AT_FK_EMPLEADO FOREIGN KEY (ID_EMPLEADO) REFERENCES EMPLEADO(ID_EMPLEADO),
  CONSTRAINT AT_FK_TURNO FOREIGN KEY (ID_TURNO) REFERENCES TURNO(ID_TURNO),
  CONSTRAINT AT_FK_MAQUINA FOREIGN KEY (NRO_MAQUINA, PLANTA_ID) REFERENCES MAQUINA(NRO_MAQUINA, PLANTA_ID),
  CONSTRAINT AT_UX_EMPLEADO_FECHA UNIQUE (ID_EMPLEADO, FECHA)
);

-- poblamiento, poquitos ejemplos

-- regiones
INSERT INTO REGION (ID_REGION, NOMBRE_REGION) VALUES (21, 'Región de Valparaíso');
INSERT INTO REGION (ID_REGION, NOMBRE_REGION) VALUES (22, 'Región Metropolitana');

-- comunas
INSERT INTO COMUNA (NOMBRE_COMUNA, REGION_ID) VALUES ('Quilpué', 21);
INSERT INTO COMUNA (NOMBRE_COMUNA, REGION_ID) VALUES ('Maipú', 22);

-- plantas
INSERT INTO PLANTA (ID_PLANTA, NOMBRE_PLANTA, DIRECCION, COMUNA_ID)
VALUES (45, 'Planta Oriente', 'Camino Industrial 1234', 1050);

INSERT INTO PLANTA (ID_PLANTA, NOMBRE_PLANTA, DIRECCION, COMUNA_ID)
VALUES (46, 'Planta Costa', 'Av. Vidrieras 890', 1055);

-- tipomaquina
INSERT INTO TIPO_MAQUINA (ID_TIPO_MAQUINA, NOMBRE_TIPO) VALUES (1, 'Horno');
INSERT INTO TIPO_MAQUINA (ID_TIPO_MAQUINA, NOMBRE_TIPO) VALUES (2, 'Línea IS');
INSERT INTO TIPO_MAQUINA (ID_TIPO_MAQUINA, NOMBRE_TIPO) VALUES (3, 'Templado');
INSERT INTO TIPO_MAQUINA (ID_TIPO_MAQUINA, NOMBRE_TIPO) VALUES (4, 'Inspección');
INSERT INTO TIPO_MAQUINA (ID_TIPO_MAQUINA, NOMBRE_TIPO) VALUES (5, 'Empaque');

-- turnos
INSERT INTO TURNO (ID_TURNO, NOMBRE_TURNO, HORA_INICIO, HORA_FIN) VALUES ('M0715', 'Mañana', '07:00', '15:00');
INSERT INTO TURNO (ID_TURNO, NOMBRE_TURNO, HORA_INICIO, HORA_FIN) VALUES ('T1523', 'Tarde', '15:00', '23:00');
INSERT INTO TURNO (ID_TURNO, NOMBRE_TURNO, HORA_INICIO, HORA_FIN) VALUES ('N2307', 'Noche', '23:00', '07:00');

-- maquinas
-- maquina 100 
INSERT INTO MAQUINA (NRO_MAQUINA, PLANTA_ID, NOMBRE_MAQUINA, ESTADO_ACTIVO, ID_TIPO_MAQUINA)
VALUES (100, 45, 'Horno Oriente A', 'S', 1);

-- maquina 200
INSERT INTO MAQUINA (NRO_MAQUINA, PLANTA_ID, NOMBRE_MAQUINA, ESTADO_ACTIVO, ID_TIPO_MAQUINA)
VALUES (200, 46, 'Línea IS Costa 1', 'S', 2);

-- empleados de ejemplo
-- jefe de turno
INSERT INTO EMPLEADO (ID_EMPLEADO, RUT, NOMBRES, APELLIDOS, FECHA_CONTRATACION, SUELDO_BASE, ESTADO_ACTIVO, PLANTA_ID, AFP, SISTEMA_SALUD, JEFE_DIRECTO_ID)
VALUES (1001, '12.345.678-9', 'Carlos', 'González', TO_DATE('2018-04-01','YYYY-MM-DD'), 1500000, 'S', 45, 'Provida', 'Fonasa', NULL);

INSERT INTO JEFE_TURNO (ID_EMPLEADO, AREA_RESPONSABILIDAD, MAX_OPERARIOS)
VALUES (1001, 'Formado y Línea A', 12);

-- operario
INSERT INTO EMPLEADO (ID_EMPLEADO, RUT, NOMBRES, APELlIDOS, FECHA_CONTRATACION, SUELDO_BASE, ESTADO_ACTIVO, PLANTA_ID, AFP, SISTEMA_SALUD, JEFE_DIRECTO_ID)
VALUES (1002, '18.765.432-1', 'María', 'López', TO_DATE('2020-01-15','YYYY-MM-DD'), 800000, 'S', 45, 'Habitat', 'Isapre', 1001);

INSERT INTO OPERARIO (ID_EMPLEADO, CATEGORIA_PROCESO, CERTIFICACION, HORAS_POR_TURNO)
VALUES (1002, 'Caliente', 'Certificado Moldeo Nivel 2', 8);

-- tecnico
INSERT INTO EMPLEADO (ID_EMPLEADO, RUT, NOMBRES, APELLIDOS, FECHA_CONTRATACION, SUELDO_BASE, ESTADO_ACTIVO, PLANTA_ID, AFP, SISTEMA_SALUD, JEFE_DIRECTO_ID)
VALUES (1003, '20.123.456-7', 'Juan', 'Pérez', TO_DATE('2019-07-30','YYYY-MM-DD'), 1100000, 'S', 46, 'Cuprum', 'Fonasa', NULL);

INSERT INTO TECNICO_MANT (ID_EMPLEADO, ESPECIALIDAD, NIVEL_CERTIFICACION, TIEMPO_RESPUESTA_ESTANDAR)
VALUES (1003, 'Eléctrica', 'Nivel 3', 120);

-- mantencion orden
INSERT INTO ORDEN_MANTENCION (ID_ORDEN, NRO_MAQUINA, PLANTA_ID, ID_TECNICO, FECHA_PROGRAMADA, FECHA_EJECUCION, DESCRIPCION)
VALUES (1, 100, 45, 1003, TO_DATE('2025-10-10','YYYY-MM-DD'), TO_DATE('2025-10-12','YYYY-MM-DD'), 'Cambio de refractarios y ajuste de feeder.');

-- orden programada pero no ejecutada todavia
INSERT INTO ORDEN_MANTENCION (ID_ORDEN, NRO_MAQUINA, PLANTA_ID, ID_TECNICO, FECHA_PROGRAMADA, FECHA_EJECUCION, DESCRIPCION)
VALUES (2, 200, 46, 1003, TO_DATE('2025-10-20','YYYY-MM-DD'), NULL, 'Mantenimiento preventivo línea IS.');

-- asignaciones
INSERT INTO ASIGNACION_TURNO (ID_ASIGNACION, FECHA, ID_EMPLEADO, ID_TURNO, NRO_MAQUINA, PLANTA_ID, ROL_EN_TURNO)
VALUES (1, TO_DATE('2025-10-07','YYYY-MM-DD'), 1002, 'M0715', 100, 45, 'Moldeador');

-- Otra asignación (distinto empleado o distinta fecha)
INSERT INTO ASIGNACION_TURNO (ID_ASIGNACION, FECHA, ID_EMPLEADO, ID_TURNO, NRO_MAQUINA, PLANTA_ID, ROL_EN_TURNO)
VALUES (2, TO_DATE('2025-10-07','YYYY-MM-DD'), 1001, 'M0715', 100, 45, 'Jefe de Línea');

COMMIT;

-- -----------------
-- fase 4: consultas
-- -----------------

-- informe 1:
-- para listar los turnos cuyo horario de inicio sea posterior a '20:00'
SELECT
  ID_TURNO AS TURNO,
  HORA_INICIO AS ENTRADA,
  HORA_FIN AS SALIDA
FROM TURNO
WHERE HORA_INICIO > '20:00'
ORDER BY HORA_INICIO DESC;

-- informe 2:
-- turnos diurnos con hora_inicio entre '06:00' y '14:59'
SELECT
  NOMBRE_TURNO || ' (' || ID_TURNO || ')' AS TURNO,
  HORA_INICIO AS ENTRADA,
  HORA_FIN AS SALIDA
FROM TURNO
WHERE HORA_INICIO BETWEEN '06:00' AND '14:59'
ORDER BY HORA_INICIO ASC;
 
 
-- informe 3:
-- informacion general
SELECT
    e.ID_EMPLEADO,
    e.RUT,
    e.NOMBRES || ' ' || e.APELLIDOS AS NOMBRE_COMPLETO,
    CASE 
        WHEN jt.ID_EMPLEADO IS NOT NULL THEN 'Jefe de Turno'
        WHEN op.ID_EMPLEADO IS NOT NULL THEN 'Operario'
        WHEN tm.ID_EMPLEADO IS NOT NULL THEN 'Técnico de Mantención'
        ELSE 'Sin rol'
    END AS ROL,
    jt.AREA_RESPONSABILIDAD AS AREA_JEFE,
    jt.MAX_OPERARIOS AS MAX_OPERARIOS,
    op.CATEGORIA_PROCESO AS CATEGORIA_OPERARIO,
    op.CERTIFICACION AS CERTIFICACION_OPERARIO,
    op.HORAS_POR_TURNO AS HORAS_TURNO,
    tm.ESPECIALIDAD AS ESPECIALIDAD_TECNICO,
    tm.NIVEL_CERTIFICACION AS NIVEL_TECNICO,
    tm.TIEMPO_RESPUESTA_ESTANDAR AS TIEMPO_RESPUESTA,
    a.FECHA AS FECHA_ASIGNACION,
    t.NOMBRE_TURNO AS NOMBRE_TURNO,
    a.ROL_EN_TURNO AS ROL_EN_TURNO,
    m.NOMBRE_MAQUINA AS NOMBRE_MAQUINA,
    m.ESTADO_ACTIVO AS ESTADO_MAQUINA,
    ma.NOMBRE_TIPO AS TIPO_MAQUINA,
    p.NOMBRE_PLANTA AS NOMBRE_PLANTA,
    c.NOMBRE_COMUNA AS COMUNA,
    r.NOMBRE_REGION AS REGION,
    o.FECHA_PROGRAMADA AS FECHA_ORDEN,
    o.FECHA_EJECUCION AS FECHA_EJECUCION,
    o.DESCRIPCION AS DESCRIPCION_ORDEN
FROM EMPLEADO e
LEFT JOIN JEFE_TURNO jt ON e.ID_EMPLEADO = jt.ID_EMPLEADO
LEFT JOIN OPERARIO op ON e.ID_EMPLEADO = op.ID_EMPLEADO
LEFT JOIN TECNICO_MANT tm ON e.ID_EMPLEADO = tm.ID_EMPLEADO
LEFT JOIN ASIGNACION_TURNO a ON e.ID_EMPLEADO = a.ID_EMPLEADO
LEFT JOIN TURNO t ON a.ID_TURNO = t.ID_TURNO
LEFT JOIN MAQUINA m ON a.NRO_MAQUINA = m.NRO_MAQUINA AND a.PLANTA_ID = m.PLANTA_ID
LEFT JOIN TIPO_MAQUINA ma ON m.ID_TIPO_MAQUINA = ma.ID_TIPO_MAQUINA
LEFT JOIN PLANTA p ON e.PLANTA_ID = p.ID_PLANTA
LEFT JOIN COMUNA c ON p.COMUNA_ID = c.ID_COMUNA
LEFT JOIN REGION r ON c.REGION_ID = r.ID_REGION
LEFT JOIN ORDEN_MANTENCION o ON e.ID_EMPLEADO = o.ID_TECNICO
ORDER BY e.ID_EMPLEADO, a.FECHA;

-- plop